{% extends 'base.html' %} 
{% block title %}æŠ½çæ´»å‹•{% endblock %} 
{% block content %}
<h1>é¸æ“‡æ´»å‹•é€²è¡ŒæŠ½ç</h1>
<ul>
  {% for event in events %}
  <li>
    {{ event.name }}
    <button onclick="showDrawPopup({{ event.id }}, '{{ event.name }}')">
      æŠ½ç
    </button>
  </li>
  {% endfor %}
</ul>

<!-- æŠ½çå½ˆå‡ºè¦–çª— -->
<div
  id="drawPopup"
  style="
    display: none;
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -30%);
    background: white;
    padding: 20px;
    border: 1px solid black;
  "
>
  <h2 id="popupEventName"></h2>
  <label>è«‹è¼¸å…¥æŠ½çäººæ•¸ï¼š</label>
  <input type="number" id="numWinners" min="1" />
  <button onclick="confirmDraw()">ç¢ºèªæŠ½ç</button>
  <button onclick="closePopup()">å–æ¶ˆ</button>
</div>

<!-- é¡¯ç¤ºä¸­çåå–® -->
<div id="winnerList" style="display: none; margin-top: 20px">
  <h2>ä¸­çåå–®</h2>
  <ul id="winners"></ul>
</div>

<script>
  let selectedEventId = null;

  function showDrawPopup(eventId, eventName) {
    selectedEventId = eventId;
    document.getElementById("popupEventName").innerText =
      "æŠ½çæ´»å‹•ï¼š" + eventName;
    document.getElementById("drawPopup").style.display = "block";
  }

  function closePopup() {
    document.getElementById("drawPopup").style.display = "none";
  }

  function confirmDraw() {
    let numWinners = document.getElementById("numWinners").value;
    if (!numWinners || isNaN(numWinners) || numWinners <= 0) {
      alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—");
      return;
    }

    fetch(`/draw_winners/${selectedEventId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrf_token,
      },
      body: JSON.stringify({
        num_winners: numWinners,
        event_id: selectedEventId,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          alert("éŒ¯èª¤ï¼š" + data.error);
        } else {
          alert("æŠ½çå®Œæˆï¼");

          // é¡¯ç¤ºä¸­çåå–®
          let winnerList = document.getElementById("winners");
          winnerList.innerHTML = "";
          data.winners.forEach((user) => {
            let li = document.createElement("li");
            li.innerHTML = `ğŸ‰ æ­å–œ ${user.name} - ${user.email} ğŸ‰`;
            winnerList.appendChild(li);
          });

          document.getElementById("winnerList").style.display = "block";
        }
      })
      .catch((error) => console.error("æŠ½çéŒ¯èª¤ï¼š", error));

    closePopup();
  }
</script>

{% endblock %}
